---
id: v1
title: v1 协议
---

## 说明

在 v1 之前的协议存在两个问题:

1. v0 协议 `Transaction` 结构中目标地址 `to` 字段类型为 `String`，即十六进制字符。但是链上存储时是按照 bytes 类型存储的。
因为字符大小写的问题，导致交易具有可变性，无法准确恢复出发送交易的地址。因此，在 v1 协议中，将目标地址的类型由 `String` 改为 `bytes`。

2. v0 协议 `Transaction` 结构中 `chain_id` 字段类型为 `u32`。每条链有唯一的 `chain_id`，但 `u32` 取值空间太小，
必须有中心化机构协调才能保证不会出现两条链的 `chain_id` 重复的情况。因此，在 v1 协议中，将`chain_id`的类型由 `u32` 改为 `bytes(u256)`。
这样链的运营方可以选择使用 uuid 或者随机的哈希值作为 `chain_id`，不需要中心化机构协调，也可以在很大概率上保证 `chain_id` 的唯一。

## 对应 RELEASE 版本

[v0.20](https://github.com/cryptape/cita/releases/tag/v0.20) 及以上版本

## 协议变更

- Transaction 结构中增加 `to_v1` 字段，类型 `bytes`。在链的协议版本为 v1 时，原来 `to` 字段不再使用。

- Transaction 结构中增加 `chain_id_v1` 字段，类型 `bytes(u256)`。在链的协议版本为 v1 时，原来 `chain_id` 字段不再使用。

- Transaction 结构中的 `version` 字段必须填 1。

## 实施协议升级

1. 安排所有节点升级 CITA 版本至 v0.20 及以上版本。
2. 升级系统合约。 参数是 `Admin`, `private key`, `chain id`, `version`, `url`.

>注意：这里的参数仅作为演示使用，请实际操作时替换为目标链的相应参数

```
$ ./env.sh scripts/amend_sys_cont_to_v0-20.sh 0x5f0258a4778057a8a7d97809bd209055b2fbafa654ce7d31ec7191066b9225e6 1 0 http://127.0.0.1:1337
```

3. 使用超级管理员账户，执行如下 `协议升级`命令

> 注意：这里的admin-private私钥仅作为演示使用，请实际操作时替换为目标链的实际私钥。

```
$ cita-cli scm VersionManager setVersion --admin-private 0x5f0258a4778057a8a7d97809bd209055b2fbafa654ce7d31ec7191066b9225e6 --version 1
```

4. 用户升级相关工具和 SDK 至明确支持 v1 协议的版本，具体请参见 SDK 和 工具的 RELEASE NOTES。

## 注意

1. 原来的 `to` 字段和 `chain_id` 字段一定不能填，否则会有交易可变性问题, 协议升级之后有相关的检查，发现 `to` 字段和 `chain_id` 字段不为空就报错。
2. 因为跨链功能目前还没有正式使用，因此升级后相关工具将不再支持 v0 协议，只支持 v1 协议。
